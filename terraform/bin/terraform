#!/usr/bin/env sh
set -ex

SCRIPT_PATH="$(dirname "$0" | xargs realpath)"

TERRAFORM_URL="https://releases.hashicorp.com/terraform/0.14.9/terraform_0.14.9_linux_amd64.zip"
TERRAFORM_CHECKSUM_URL="https://releases.hashicorp.com/terraform/0.14.9/terraform_0.14.9_SHA256SUMS"
EXE_PATH="${SCRIPT_PATH}/terraform.executable"
CHECKSUM_PATH="${SCRIPT_PATH}/terraform.sha256sum"

download() {
  # lookups for either curl or wget and downloads file to requested position
  URL="$1"
  OUTPUT="$2"
  echo "info: downloading $URL"
  if command -v curl 1>/dev/null; then
    if [ "$OUTPUT" = '' ]; then
      curl -fsSLO "$URL"
    else
      curl -fsSLo "$OUTPUT" "$URL"
    fi
  elif command -v wget 1>/dev/null; then
    if [ "$OUTPUT" = '' ]; then
      wget -q --content-disposition "$URL"
    else
      wget -qO "$OUTPUT" "$URL"
    fi
  fi
}

if [ ! -f "$EXE_PATH" ] || ! sha256sum -c "$CHECKSUM_PATH" --status; then
  cd "$(mktemp -d)"
  download "$TERRAFORM_URL"
  download "$TERRAFORM_CHECKSUM_URL" checksum
  sha256sum -c checksum --ignore-missing
  unzip terraform*.zip
  install -m 0755 terraform "$EXE_PATH"
  sha256sum "$EXE_PATH" > "$CHECKSUM_PATH"
  pwd | xargs rm -rf
  cd - 1>/dev/null
fi

exec "$EXE_PATH" "$@"
